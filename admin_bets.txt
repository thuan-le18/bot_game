from aiogram import Router, types
from aiogram.filters import Text
from config import ADMIN_ID  # ID của admin
from database import user_bets  # Dữ liệu cược của người chơi

router = Router()

@router.message(Text("📊 Xem cược hiện tại"), lambda msg: msg.from_user.id == ADMIN_ID)
async def view_current_bets(message: types.Message):
    if not user_bets:
        await message.answer("📌 Hiện không có ai đang cược.")
        return

    bet_info = "📊 Danh sách cược hiện tại:\n\n"
    for user_id, bet_data in user_bets.items():
        bet_info += f"👤 User {user_id} - {bet_data['game']} - {bet_data['amount']} VNĐ\n"

    await message.answer(bet_info)

@router.message(Text("⚙️ Chỉnh kết quả"), lambda msg: msg.from_user.id == ADMIN_ID)
async def edit_game_result(message: types.Message):
    await message.answer("🛠 Nhập theo cú pháp: /fix_game [User ID] [Thắng/Thua]")

@router.message(lambda msg: msg.text.startswith("/fix_game") and msg.from_user.id == ADMIN_ID)
async def set_game_result(message: types.Message):
    parts = message.text.split()
    if len(parts) != 3:
        await message.answer("⚠️ Sai cú pháp! Nhập: /fix_game [User ID] [Thắng/Thua]")
        return

    user_id, result = parts[1], parts[2].lower()
    if user_id not in user_bets:
        await message.answer("⚠️ User không có cược nào!")
        return

    if result == "thắng":
        payout = user_bets[user_id]["amount"] * 1.96  # Nhân tiền thắng
        user_balance[user_id] += payout
        await message.answer(f"✅ Đã cập nhật: User {user_id} THẮNG +{payout} VNĐ")
    else:
        await message.answer(f"✅ Đã cập nhật: User {user_id} THUA")

    del user_bets[user_id]  # Xóa cược sau khi xử lý
